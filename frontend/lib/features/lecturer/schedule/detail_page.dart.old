// ignore_for_file: deprecated_member_use

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:file_picker/file_picker.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:dio/dio.dart';
import 'service.dart';
import 'package:qlgd_lhk/common/widgets/tlu_app_bar.dart';

class LecturerScheduleDetailPage extends StatefulWidget {
  final int sessionId;
  final Map<String, dynamic>? sessionData; // Session data đã gộp từ home page
  
  const LecturerScheduleDetailPage({
    super.key,
    required this.sessionId,
    this.sessionData,
  });

  @override
  State<LecturerScheduleDetailPage> createState() =>
      _LecturerScheduleDetailPageState();
}

class _LecturerScheduleDetailPageState
    extends State<LecturerScheduleDetailPage> {
  // Service để gọi API
  final LecturerScheduleService _svc = LecturerScheduleService();

  bool _loading = true;
  String? _error;

  Map<String, dynamic> _detail = {};
  List<Map<String, dynamic>> _materials = [];

  final TextEditingController _newMaterialCtrl = TextEditingController();
  final TextEditingController _noteCtrl = TextEditingController();
  
  // Trạng thái hiện tại từ backend (PLANNED, TEACHING, DONE, CANCELED, MAKEUP_PLANNED, MAKEUP_DONE)
  String _currentStatus = 'PLANNED';
  bool _hasAttendance = false;

  @override
  void initState() {
    super.initState();
    _load();
  }

  @override
  void dispose() {
    _newMaterialCtrl.dispose();
    _noteCtrl.dispose();
    super.dispose();
  }

  Future<void> _load() async {
    setState(() {
      _loading = true;
      _error = null;
    });
    try {
      final d = await _svc.getDetail(widget.sessionId);
      final m = await _svc.getMaterials(widget.sessionId);
      
      // Lấy trạng thái từ backend (uppercase)
      final rawStatus = (d['status'] ?? 'PLANNED').toString().toUpperCase();
      _currentStatus = rawStatus;
      
      // Kiểm tra điểm danh
      _hasAttendance = await _svc.checkAttendance(widget.sessionId);

      _detail = d;
      _materials = m;

      final note = (d['note'] ?? '').toString();
      if (note.isNotEmpty) _noteCtrl.text = note;
    } catch (e) {
      _error = e.toString();
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  String _hhmm(dynamic s) {
    final str = (s ?? '').toString();
    return str.length >= 5 ? str.substring(0, 5) : str;
  }

  String _fmtDate(String? iso) {
    if (iso == null || iso.isEmpty) return '';
    final p = iso.split('-');
    return p.length == 3 ? '${p[2]}/${p[1]}/${p[0]}' : iso;
  }

  Future<void> _addMaterial() async {
    final title = _newMaterialCtrl.text.trim();
    if (title.isEmpty) return;
    await _svc.addMaterial(widget.sessionId, title);
    _newMaterialCtrl.clear();
    final m = await _svc.getMaterials(widget.sessionId);
    if (!mounted) return;
    setState(() => _materials = m);
  }

  Future<void> _pickAndUploadFile() async {
    try {
      // Chọn file (PDF, PPT, Word)
      final result = await FilePicker.platform.pickFiles(
        type: FileType.custom,
        allowedExtensions: ['pdf', 'ppt', 'pptx', 'doc', 'docx'],
        allowMultiple: false,
      );

      if (result == null || result.files.isEmpty) return;

      final file = result.files.first;
      if (file.path == null) return;

      // Hiển thị dialog để nhập title
      final title = await showDialog<String>(
        context: context,
        builder: (context) {
          final titleCtrl = TextEditingController();
          return AlertDialog(
            title: const Text('Thêm tài liệu'),
            content: TextField(
              controller: titleCtrl,
              decoration: const InputDecoration(
                labelText: 'Tên tài liệu',
                hintText: 'Ví dụ: Bài giảng chương 1',
              ),
              autofocus: true,
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text('Hủy'),
              ),
              FilledButton(
                onPressed: () {
                  final title = titleCtrl.text.trim();
                  if (title.isNotEmpty) {
                    Navigator.pop(context, title);
                  }
                },
                child: const Text('Upload'),
              ),
            ],
          );
        },
      );

      if (title == null || title.isEmpty) return;

      // Upload file
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Đang upload file...')),
      );

      // Xác định file type
      final extension = file.extension?.toLowerCase() ?? '';
      String? fileType;
      if (extension == 'pdf') {
        fileType = 'application/pdf';
      } else if (extension == 'ppt' || extension == 'pptx') {
        fileType = 'application/vnd.ms-powerpoint';
      } else if (extension == 'doc' || extension == 'docx') {
        fileType = 'application/msword';
      }

      await _svc.uploadMaterialFile(
        sessionId: widget.sessionId,
        title: title,
        filePath: file.path!,
        fileType: fileType,
      );

      // Reload materials
      final m = await _svc.getMaterials(widget.sessionId);
      if (!mounted) return;
      setState(() => _materials = m);

      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Đã upload tài liệu thành công')),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: ${e.toString()}')),
      );
    }
  }

  // Xóa material
  Future<void> _deleteMaterial(int materialId) async {
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Xác nhận xóa'),
        content: const Text('Bạn có chắc muốn xóa nội dung này?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(ctx).pop(false),
            child: const Text('Hủy'),
          ),
          FilledButton(
            onPressed: () => Navigator.of(ctx).pop(true),
            style: FilledButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('Xóa'),
          ),
        ],
      ),
    );

    if (confirmed != true) return;

    try {
      await _svc.deleteMaterial(widget.sessionId, materialId);
      if (!mounted) return;
      
      // Reload danh sách materials
      final m = await _svc.getMaterials(widget.sessionId);
      setState(() => _materials = m);
      
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Đã xóa nội dung')),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Lỗi khi xóa: ${e.toString()}'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Getter để kiểm tra xem có thể chỉnh sửa không
  bool get _isEditable {
    return _currentStatus != 'DONE' && _currentStatus != 'CANCELED';
  }

  // Getter để kiểm tra xem có thể kết thúc buổi học không
  bool get _canEndSession {
    return _currentStatus == 'PLANNED' || _currentStatus == 'TEACHING';
  }

  // Getter để kiểm tra xem đã hoàn thành chưa
  bool get _isCompleted {
    return _currentStatus == 'DONE';
  }

  // Hàm kết thúc buổi học
  Future<void> _endSession() async {
    // Reload lại để đảm bảo _hasAttendance được cập nhật mới nhất
    // (trường hợp người dùng vừa điểm danh xong)
    try {
      _hasAttendance = await _svc.checkAttendance(widget.sessionId);
    } catch (e) {
      // Nếu check lỗi, vẫn tiếp tục với giá trị hiện tại
      print('Error checking attendance: $e');
    }

    // Kiểm tra điểm danh trước
    if (!_hasAttendance) {
      // Hiển thị dialog cảnh báo
      final shouldContinue = await showDialog<bool>(
        context: context,
        builder: (context) => AlertDialog(
          title: const Text('Chưa điểm danh'),
          content: const Text(
            'Bạn chưa điểm danh sinh viên. Vui lòng điểm danh trước khi kết thúc buổi học.',
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context, false),
              child: const Text('Hủy'),
            ),
            FilledButton(
              onPressed: () {
                // Chuyển đến trang điểm danh
                Navigator.pop(context, true);
                final groupedIds = widget.sessionData?['_grouped_session_ids'] as List?;
                final subjVal = _detail['subject'];
                final asg = _detail['assignment'];
                final subjMap = (subjVal is Map)
                    ? subjVal
                    : (asg is Map && asg['subject'] is Map ? asg['subject'] : null);
                final subject = (subjMap is Map
                        ? (subjMap['name'] ?? subjMap['code'])
                        : (subjVal ?? ''))
                    .toString();
                final cuVal = _detail['class_unit'] ?? _detail['class'];
                final cuMap = (cuVal is Map)
                    ? cuVal
                    : (asg is Map && asg['classUnit'] is Map ? asg['classUnit'] : null);
                final className = (cuMap is Map
                        ? (cuMap['name'] ?? cuMap['code'])
                        : (_detail['class_name'] ?? ''))
                    .toString();
                context.push(
                  '/attendance/${widget.sessionId}',
                  extra: {
                    'subjectName': subject,
                    'className': className,
                    'groupedSessionIds': groupedIds,
                  },
                );
              },
              child: const Text('Điểm danh ngay'),
            ),
          ],
        ),
      );
      
      if (shouldContinue == true) {
        // Đã chuyển đến trang điểm danh, không làm gì thêm
        return;
      }
      return; // Người dùng hủy
    }

    // Xác nhận kết thúc buổi học
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Kết thúc buổi học'),
        content: const Text('Bạn có chắc chắn muốn kết thúc buổi học này?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Hủy'),
          ),
          FilledButton(
            onPressed: () => Navigator.pop(context, true),
            child: const Text('Xác nhận'),
          ),
        ],
      ),
    );

    if (confirmed != true) return;

    // Hiển thị loading indicator
    if (!mounted) return;
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(
        child: CircularProgressIndicator(),
      ),
    );

    try {
      // Gọi API kết thúc buổi học
      final responseData = await _svc.completeSession(widget.sessionId);
      
      // Cập nhật status ngay từ response (không cần reload)
      if (responseData['status'] != null) {
        final newStatus = responseData['status'].toString().toUpperCase();
        setState(() {
          _currentStatus = newStatus;
        });
      }
      
      // Đóng loading dialog
      if (mounted) Navigator.pop(context);
      
      // Reload để đảm bảo dữ liệu đồng bộ (nhưng status đã được cập nhật ở trên)
      await _load();
      
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Đã kết thúc buổi học')),
      );
    } catch (e) {
      // Đóng loading dialog nếu có lỗi
      if (mounted) Navigator.pop(context);
      
      if (!mounted) return;
      
      // Parse error message từ Dio
      String errorMessage = 'Lỗi không xác định';
      if (e is DioException) {
        if (e.response != null) {
          final data = e.response!.data;
          if (data is Map && data['message'] != null) {
            errorMessage = data['message'].toString();
          } else {
            errorMessage = 'Lỗi: ${e.response!.statusCode}';
          }
        } else {
          errorMessage = 'Không thể kết nối đến server';
        }
      } else {
        errorMessage = e.toString();
      }
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(errorMessage),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 5),
        ),
      );
    }
  }

  Future<void> _saveReport() async {
    try {
      await _svc.submitReport(
        sessionId: widget.sessionId,
        note: _noteCtrl.text,
      );
      if (!mounted) return;
      
      // Reload để đảm bảo UI cập nhật với dữ liệu mới nhất
      await _load();
      
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Đã lưu báo cáo buổi học')),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Lỗi khi lưu: ${e.toString()}'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Hàm helper để lấy label cho trạng thái
  String _getStatusLabel(String status) {
    switch (status.toUpperCase()) {
      case 'PLANNED':
        return 'Đã lên kế hoạch';
      case 'TEACHING':
        return 'Đang dạy';
      case 'DONE':
        return 'Đã hoàn thành';
      case 'CANCELED':
        return 'Đã hủy';
      case 'MAKEUP_PLANNED':
        return 'Lên lịch dạy bù';
      case 'MAKEUP_DONE':
        return 'Đã dạy bù';
      default:
        return status;
    }
  }

  // Hàm helper để lấy màu cho trạng thái
  Color _getStatusColor(String status) {
    switch (status.toUpperCase()) {
      case 'PLANNED':
        return Colors.blue;
      case 'TEACHING':
        return Colors.orange;
      case 'DONE':
        return Colors.green;
      case 'CANCELED':
        return Colors.red;
      case 'MAKEUP_PLANNED':
        return Colors.purple;
      case 'MAKEUP_DONE':
        return Colors.teal;
      default:
        return Colors.grey;
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    if (_loading) {
      return Scaffold(
        appBar: const TluAppBar(),
        body: const Center(child: CircularProgressIndicator()),
      );
    }
    if (_error != null) {
      return Scaffold(
        appBar: const TluAppBar(),
        body: Center(
          child: Text(
            'Không tải được dữ liệu.\n$_error',
            textAlign: TextAlign.center,
            style: const TextStyle(color: Colors.red),
          ),
        ),
      );
    }

    // ===== Normalize fields for display =====
    // Subject/Class
    final subjVal = _detail['subject'];
    final asg = _detail['assignment'];
    final subjMap = (subjVal is Map)
        ? subjVal
        : (asg is Map && asg['subject'] is Map ? asg['subject'] : null);
    final subject = (subjMap is Map
            ? (subjMap['name'] ?? subjMap['code'])
            : (subjVal ?? ''))
        .toString();

    final cuVal = _detail['class_unit'] ?? _detail['class'];
    final cuMap = (cuVal is Map)
        ? cuVal
        : (asg is Map && asg['classUnit'] is Map ? asg['classUnit'] : null);
    final className = (cuMap is Map
            ? (cuMap['name'] ?? cuMap['code'])
            : (_detail['class_name'] ?? ''))
        .toString();

    // Date
    final rawDate = ((_detail['date'] ??
                _detail['session_date'] ??
                _detail['sessionDate']) ??
            '')
        .toString();
    final dateOnly = rawDate.contains(' ') ? rawDate.split(' ').first : rawDate;
    final date = _fmtDate(dateOnly);

    // Time - Nếu có sessionData đã gộp từ home page, ưu tiên dùng thời gian đã gộp
    String start = '';
    String end = '';
    
    if (widget.sessionData != null) {
      // Nếu có session data đã gộp, dùng thời gian đã gộp (cả buổi)
      final mergedStart = widget.sessionData!['start_time'];
      final mergedEnd = widget.sessionData!['end_time'];
      if (mergedStart != null) start = _hhmm(mergedStart);
      if (mergedEnd != null) end = _hhmm(mergedEnd);
    }
    
    // Nếu không có hoặc thiếu, lấy từ detail API (cho trường hợp load trực tiếp từ URL)
    if (start.isEmpty || end.isEmpty) {
      final ts = _detail['timeslot'];
      start = _hhmm(_detail['start_time'] ??
          _detail['start'] ??
          (ts is Map ? ts['start_time'] : null));
      end = _hhmm(_detail['end_time'] ??
          _detail['end'] ??
          (ts is Map ? ts['end_time'] : null));
    }

    // Room
    final r = _detail['room'];
    final room = (r is Map
            ? (r['name']?.toString() ?? r['code']?.toString() ?? '')
            : r?.toString() ?? '')
        .trim();

    return Scaffold(
      appBar: const TluAppBar(),
      body: SafeArea(
        child: Column(
          children: [
            Expanded(
              child: RefreshIndicator(
                onRefresh: _load,
                child: ListView(
                  padding: const EdgeInsets.fromLTRB(16, 12, 16, 16),
                  children: [
                    Text(
                      '$subject - $className',
                      style: theme.textTheme.titleMedium
                          ?.copyWith(fontWeight: FontWeight.w600),
                    ),
                    const SizedBox(height: 12),
                    SizedBox(
                      width: double.infinity,
                      child: FilledButton.icon(
                        onPressed: () {
                          // Kiểm tra xem có _grouped_session_ids không (buổi học đã được gộp)
                          final groupedIds = widget.sessionData?['_grouped_session_ids'] as List?;
                          
                          context.push(
                            '/attendance/${widget.sessionId}',
                            extra: {
                              'subjectName': subject,
                              'className': className,
                              'groupedSessionIds': groupedIds, // Truyền danh sách session IDs đã gộp
                            },
                          );
                        },
                        icon: const Icon(Icons.playlist_add_check),
                        label: const Text('Điểm danh sinh viên'),
                      ),
                    ),
                    const SizedBox(height: 16),
                    _kv('Ca',
                        (start.isEmpty && end.isEmpty) ? '-' : '$start - $end'),
                    _kv('Ngày', date.isEmpty ? '-' : date),
                    _kv('Phòng', room.isEmpty ? '-' : room),
                    const SizedBox(height: 12),
                    Text(
                      'Nội dung bài học',
                      style: theme.textTheme.titleMedium
                          ?.copyWith(fontWeight: FontWeight.w600),
                    ),
                    const SizedBox(height: 8),
                    if (_materials.isEmpty)
                      _materialTile(
                        theme,
                        title: 'Chưa có nội dung',
                        disabled: true,
                      )
                    else
                      ..._materials.map(
                        (m) => _materialTile(
                          theme,
                          title: (m['title'] ?? '').toString(),
                          subtitle: (m['uploaded_at'] ?? '').toString(),
                          url: (m['file_url'] ?? '').toString(),
                          fileType: (m['file_type'] ?? '').toString(),
                          materialId: m['id'] as int?,
                        ),
                      ),
                    const SizedBox(height: 8),
                    Row(
                      children: [
                        Expanded(
                          child: TextField(
                            controller: _newMaterialCtrl,
                            enabled: _isEditable,
                            decoration: InputDecoration(
                              prefixIcon: const Icon(Icons.add),
                              hintText: 'Thêm nội dung bài học',
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                              contentPadding: const EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 12,
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(width: 8),
                        IconButton(
                          onPressed: _isEditable ? _pickAndUploadFile : null,
                          icon: const Icon(Icons.upload_file),
                          tooltip: 'Upload file (PDF, PPT, Word)',
                          style: IconButton.styleFrom(
                            backgroundColor: Theme.of(context).colorScheme.primaryContainer,
                          ),
                        ),
                        const SizedBox(width: 8),
                        FilledButton(
                          onPressed: _isEditable ? _addMaterial : null,
                          child: const Text('Thêm'),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    // Hiển thị trạng thái dạng Chip (read-only)
                    Row(
                      children: [
                        const Text(
                          'Trạng thái giảng dạy:',
                          style: TextStyle(fontWeight: FontWeight.w600),
                        ),
                        const SizedBox(width: 8),
                        Chip(
                          label: Text(_getStatusLabel(_currentStatus)),
                          backgroundColor: _getStatusColor(_currentStatus).withOpacity(0.2),
                          labelStyle: TextStyle(
                            color: _getStatusColor(_currentStatus),
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 12),
                    TextField(
                      controller: _noteCtrl,
                      enabled: _isEditable,
                      maxLines: 4,
                      decoration: InputDecoration(
                        labelText: 'Ghi chú',
                        alignLabelWithHint: true,
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                    ),
                    // Nút "Kết thúc buổi học" (chỉ hiển thị khi chưa hoàn thành)
                    if (_canEndSession) ...[
                      const SizedBox(height: 16),
                      SizedBox(
                        width: double.infinity,
                        child: FilledButton.icon(
                          onPressed: _endSession,
                          style: FilledButton.styleFrom(
                            backgroundColor: Colors.orange,
                            foregroundColor: Colors.white,
                          ),
                          icon: const Icon(Icons.check_circle),
                          label: const Text('Kết thúc buổi học'),
                        ),
                      ),
                    ],
                    const SizedBox(height: 80),
                  ],
                ),
              ),
            ),
            Padding(
              padding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
              child: SizedBox(
                height: 44,
                width: double.infinity,
                child: FilledButton(
                  onPressed: _isCompleted ? null : _saveReport,
                  child: Text(_isCompleted ? 'Đã kết thúc buổi học' : 'Lưu'),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _kv(String k, String v) => Padding(
        padding: const EdgeInsets.symmetric(vertical: 4),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Flexible(
              flex: 2,
              child: Text(
                '$k:',
                style: const TextStyle(fontWeight: FontWeight.w700),
              ),
            ),
            const SizedBox(width: 8),
            Expanded(
              flex: 3,
              child: Text(v),
            ),
          ],
        ),
      );


  Widget _materialTile(
    ThemeData theme, {
    required String title,
    String? subtitle,
    String? url,
    String? fileType,
    bool disabled = false,
    int? materialId,
  }) {
    final hasUrl = (url ?? '').isNotEmpty;
    
    // Xác định icon dựa trên file type
    IconData iconData = Icons.description_outlined;
    Color? iconColor;
    
    if (fileType != null && fileType.isNotEmpty) {
      if (fileType.contains('pdf')) {
        iconData = Icons.picture_as_pdf;
        iconColor = Colors.red;
      } else if (fileType.contains('powerpoint') || fileType.contains('presentation')) {
        iconData = Icons.slideshow;
        iconColor = Colors.orange;
      } else if (fileType.contains('word') || fileType.contains('msword')) {
        iconData = Icons.description;
        iconColor = Colors.blue;
      }
    }

    return Card(
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: BorderSide(color: theme.dividerColor),
      ),
      child: ListTile(
        enabled: !disabled,
        leading: Icon(iconData, color: iconColor),
        title: Text(title),
        subtitle:
            (subtitle != null && subtitle.isNotEmpty) ? Text(subtitle) : null,
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Nút xóa (chỉ hiển thị khi editable và có materialId)
            if (_isEditable && materialId != null)
              IconButton(
                icon: const Icon(Icons.delete_outline, color: Colors.red),
                onPressed: () => _deleteMaterial(materialId),
                tooltip: 'Xóa nội dung',
              ),
            // Nút mở file (nếu có URL)
            if (hasUrl) const Icon(Icons.open_in_new),
          ],
        ),
        onTap: hasUrl
            ? () async {
                // Mở file trong browser hoặc app phù hợp
                final uri = Uri.parse(url!);
                if (await canLaunchUrl(uri)) {
                  await launchUrl(uri, mode: LaunchMode.externalApplication);
                } else {
                  if (!mounted) return;
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('Không thể mở file')),
                  );
                }
              }
            : null,
        dense: true,
      ),
    );
  }
}
