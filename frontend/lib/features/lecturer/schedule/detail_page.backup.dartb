import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher_string.dart';
import 'service.dart';

class LecturerScheduleDetailPage extends StatefulWidget {
  final int sessionId;
  const LecturerScheduleDetailPage({super.key, required this.sessionId});

  @override
  State<LecturerScheduleDetailPage> createState() =>
      _LecturerScheduleDetailPageState();
}

class _LecturerScheduleDetailPageState
    extends State<LecturerScheduleDetailPage> {
  final _svc = LecturerScheduleService();

  bool _loading = true;
  String? _error;

  Map<String, dynamic> _detail = {};
  List<Map<String, dynamic>> _materials = [];

  final TextEditingController _newMaterialCtrl = TextEditingController();
  final TextEditingController _noteCtrl = TextEditingController();
  String _statusValue = 'done'; // done | teaching | canceled

  @override
  void initState() {
    super.initState();
    _load();
  }

  @override
  void dispose() {
    _newMaterialCtrl.dispose();
    _noteCtrl.dispose();
    super.dispose();
  }

  Future<void> _load() async {
    setState(() {
      _loading = true;
      _error = null;
    });
    try {
      final d = await _svc.getDetail(widget.sessionId);
      final m = await _svc.getMaterials(widget.sessionId);

      final rawStatus = (d['status'] ?? '').toString().toLowerCase();
      _statusValue = switch (rawStatus) {
        'done' || 'd� ho�n th�nh' => 'done',
        'teaching' || 'dang d?y' => 'teaching',
        'canceled' || 'cancelled' || 'h?y' => 'canceled',
        _ => 'done',
      };

      _detail = d;
      _materials = m;

      final note = (d['note'] ?? '').toString();
      if (note.isNotEmpty) _noteCtrl.text = note;
    } catch (e) {
      _error = '$e';
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  String _hhmm(dynamic s) {
    final str = (s ?? '').toString();
    return str.length >= 5 ? str.substring(0, 5) : str;
  }

  String _fmtDate(String? iso) {
    if (iso == null || iso.isEmpty) return '';
    final p = iso.split('-');
    return p.length == 3 ? '${p[2]}/${p[1]}/${p[0]}' : iso;
  }

  Future<void> _addMaterial() async {
    final title = _newMaterialCtrl.text.trim();
    if (title.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Nh?p n?i dung b�i h?c tru?c d�')),
      );
      return;
    }
    await _svc.addMaterial(widget.sessionId, title);
    _newMaterialCtrl.clear();
    final m = await _svc.getMaterials(widget.sessionId);
    if (!mounted) return;
    setState(() => _materials = m);
  }

  Future<void> _saveReport() async {
    await _svc.submitReport(
      sessionId: widget.sessionId,
      status: _statusValue, // map server n?u c?n t?i service/controller
      note: _noteCtrl.text,
    );
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('�� luu b�o c�o bu?i h?c')),
    );
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    if (_loading) {
      return const Scaffold(
        body: Center(child: CircularProgressIndicator()),
      );
    }
    if (_error != null) {
      return Scaffold(
        appBar: AppBar(title: const Text('Chi ti?t bu?i h?c')),
        body: Center(
          child: Text(
            'Kh�ng t?i du?c d? li?u.\n$_error',
            textAlign: TextAlign.center,
            style: const TextStyle(color: Colors.red),
          ),
        ),
      );
    }

        // date may come as 'date' or 'session_date' possibly with time
    // subject and class (support nested or flat)\n    final subjVal = _detail['subject'];\n    final asg     = _detail['assignment'];\n    final subjMap = (subjVal is Map) ? subjVal : (asg is Map && asg['subject'] is Map ? asg['subject'] : null);\n    final subject = (subjMap is Map ? (subjMap['name'] ?? subjMap['code']) : (subjVal ?? '')).toString();\n\n    final cuVal   = _detail['class_unit'] ?? _detail['class'];\n    final cuMap   = (cuVal is Map) ? cuVal : (asg is Map && asg['classUnit'] is Map ? asg['classUnit'] : null);\n    final className = (cuMap is Map ? (cuMap['name'] ?? cuMap['code']) : (_detail['class_name'] ?? '')).toString();\n\n    // date may come as 'date' or 'session_date' possibly with time\n    final rawDate = ((_detail['date'] ?? _detail['session_date'] ?? _detail['sessionDate']) ?? '').toString();
    final dateOnly = rawDate.contains(' ') ? rawDate.split(' ').first : rawDate;
    final date = _fmtDate(dateOnly);

    // times may be at top-level or inside 'timeslot'
    final ts = _detail['timeslot'];
    final start = _hhmm(_detail['start_time'] ?? _detail['start'] ?? (ts is Map ? ts['start_time'] : null));
    final end   = _hhmm(_detail['end_time']   ?? _detail['end']   ?? (ts is Map ? ts['end_time']   : null));

    // room may be string or object
    String room;
    final r = _detail['room'];
    if (r is Map) {
      room = (r['name'] ?? r['code'] ?? '').toString();
    } else {
      room = (r ?? '').toString();
    }    // ===== Normalize fields for display =====
    // Subject/Class: support nested (assignment.subject/classUnit) or flat
    final subjVal = _detail['subject'];
    final asg     = _detail['assignment'];
    final subjMap = (subjVal is Map)
        ? subjVal
        : (asg is Map && asg['subject'] is Map ? asg['subject'] : null);
    final subject = (subjMap is Map
            ? (subjMap['name'] ?? subjMap['code'])
            : (subjVal ?? ''))
        .toString();

    final cuVal   = _detail['class_unit'] ?? _detail['class'];
    final cuMap   = (cuVal is Map)
        ? cuVal
        : (asg is Map && asg['classUnit'] is Map ? asg['classUnit'] : null);
    final className = (cuMap is Map
            ? (cuMap['name'] ?? cuMap['code'])
            : (_detail['class_name'] ?? ''))
        .toString();

    // Date: use 'date' or 'session_date' (take only YYYY-MM-DD)
    final rawDate = ((_detail['date'] ?? _detail['session_date'] ?? _detail['sessionDate']) ?? '').toString();
    final dateOnly = rawDate.contains(' ') ? rawDate.split(' ').first : rawDate;
    final date = _fmtDate(dateOnly);

    // Time: top-level or inside 'timeslot'
    final ts = _detail['timeslot'];
    final start = _hhmm(_detail['start_time'] ?? _detail['start'] ?? (ts is Map ? ts['start_time'] : null));
    final end   = _hhmm(_detail['end_time']   ?? _detail['end']   ?? (ts is Map ? ts['end_time']   : null));

    // Room: string or object
    final r = _detail['room'];
    final room = (r is Map ? (r['name'] ?? r['code'] ?? '') : (r ?? '')).toString();
return Scaffold(
      appBar: AppBar(
        title: const Text('Chi ti?t bu?i h?c'),
        leading: const BackButton(),
      ),
      body: SafeArea(
        child: Column(
          children: [
            Expanded(
              child: RefreshIndicator(
                onRefresh: _load,
                child: ListView(
                  padding: const EdgeInsets.fromLTRB(16, 12, 16, 16),
                  children: [
                    Center(
                      child: Text(
                        'TRU?NG �?I H?C TH?Y L?I',
                        style: theme.textTheme.labelLarge?.copyWith(
                          color: theme.colorScheme.primary,
                          fontWeight: FontWeight.w700,
                          letterSpacing: .2,
                        ),
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'Chi ti?t bu?i h?c',
                      style: theme.textTheme.headlineSmall
                          ?.copyWith(fontWeight: FontWeight.w800),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      '$subject - $className',
                      style: theme.textTheme.titleMedium
                          ?.copyWith(fontWeight: FontWeight.w600),
                    ),
                    const SizedBox(height: 12),
                    SizedBox(
                      width: double.infinity,
                      child: FilledButton.icon(
                        onPressed: () {
                          // TODO: di?u hu?ng sang m�n di?m danh (attendance)
                        },
                        icon: const Icon(Icons.playlist_add_check),
                        label: const Text('�i?m danh sinh vi�n'),
                      ),
                    ),
                    const SizedBox(height: 16),
                    _kv('Ca', (start.isEmpty && end.isEmpty) ? '-' : '$start - $end'),
                    _kv('Ng?y', date.isEmpty ? '-' : date),
                    _kv('Ph?ng', room.isEmpty ? '-' : room),
                    const SizedBox(height: 12),

                    Text(
                      'N?i dung b�i h?c',
                      style: theme.textTheme.titleMedium
                          ?.copyWith(fontWeight: FontWeight.w600),
                    ),
                    const SizedBox(height: 8),

                    if (_materials.isEmpty)
                      _materialTile(theme,
                          title: 'Chua c� n?i dung', disabled: true)
                    else
                      ..._materials.map(
                            (m) => _materialTile(
                          theme,
                          title: (m['title'] ?? '').toString(),
                          subtitle:
                          (m['uploaded_at'] ?? '').toString(), // n?u c�
                          url: (m['file_url'] ?? '').toString(),
                        ),
                      ),

                    const SizedBox(height: 8),

                    Row(
                      children: [
                        Expanded(
                          child: TextField(
                            controller: _newMaterialCtrl,
                            decoration: InputDecoration(
                              prefixIcon: const Icon(Icons.add),
                              hintText: 'Th�m n?i dung b�i h?c',
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                              contentPadding: const EdgeInsets.symmetric(
                                  horizontal: 12, vertical: 12),
                            ),
                          ),
                        ),
                        const SizedBox(width: 8),
                        FilledButton(
                          onPressed: _addMaterial,
                          child: const Text('Th�m'),
                        ),
                      ],
                    ),

                    const SizedBox(height: 16),

                    DropdownButtonFormField<String>(
                      value: _statusValue,
                      decoration: InputDecoration(
                        labelText: 'Tr?ng th�i gi?ng d?y',
                        border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(12)),
                      ),
                      items: const [
                        DropdownMenuItem(
                            value: 'done', child: Text('�� ho�n th�nh')),
                        DropdownMenuItem(
                            value: 'teaching', child: Text('�ang d?y')),
                        DropdownMenuItem(
                            value: 'canceled', child: Text('H?y bu?i')),
                      ],
                      onChanged: (v) =>
                          setState(() => _statusValue = v ?? 'done'),
                    ),

                    const SizedBox(height: 12),

                    TextField(
                      controller: _noteCtrl,
                      maxLines: 4,
                      decoration: InputDecoration(
                        labelText: 'Ghi ch�',
                        alignLabelWithHint: true,
                        border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(12)),
                      ),
                    ),

                    const SizedBox(height: 80),
                  ],
                ),
              ),
            ),
            Padding(
              padding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
              child: SizedBox(
                height: 44,
                width: double.infinity,
                child: FilledButton(
                  onPressed: _saveReport,
                  child: const Text('Luu'),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _kv(String k, String v) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          SizedBox(
            width: 145,
            child: Text(
              '$k:',
              style: const TextStyle(fontWeight: FontWeight.w700),
            ),
          ),
          Expanded(child: Text(v)),
        ],
      ),
    );
  }

  Widget _materialTile(
      ThemeData theme, {
        required String title,
        String? subtitle,
        String? url,
        bool disabled = false,
      }) {
    final hasUrl = (url ?? '').isNotEmpty;
    return Card(
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: BorderSide(color: theme.dividerColor),
      ),
      child: ListTile(
        enabled: !disabled,
        leading: const Icon(Icons.description_outlined),
        title: Text(title),
        subtitle: (subtitle != null && subtitle.isNotEmpty)
            ? Text(subtitle)
            : null,
        trailing: hasUrl ? const Icon(Icons.open_in_new) : null,
        onTap: hasUrl ? () => launchUrlString(url!) : null,
        dense: true,
      ),
    );
  }
}











