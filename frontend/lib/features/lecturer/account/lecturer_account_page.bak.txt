import 'package:dio/dio.dart';
}
  }
          const SizedBox(height: 24),
          Center(
            child: CircleAvatar(
              radius: 48,
              backgroundColor: Theme.of(context).colorScheme.primaryContainer,
              backgroundImage: avatarUrl.startsWith('http') ? NetworkImage(avatarUrl) : null,
              child: avatarUrl.startsWith('http') ? null : const Icon(Icons.person_outline, size: 42),
            ),
          ),
          const SizedBox(height: 12),
          Center(
            child: FilledButton.icon(
              onPressed: _saving ? null : _openEditSheet,
              icon: const Icon(Icons.edit_outlined),
              label: const Text('Ch?nh s?a'),
            ),
          ),
          const SizedBox(height: 24),
          _infoCard(label: 'H? và tên', child: Text(_textOrPlaceholder(_profile['name']?.toString()), style: const TextStyle(fontWeight: FontWeight.w600))),
          _infoCard(label: 'Ngày sinh', child: Text(formattedDob, style: const TextStyle(fontWeight: FontWeight.w600))),
          _infoCard(label: 'Gi?i tính', child: Text(genderDisplay, style: const TextStyle(fontWeight: FontWeight.w600))),
          _infoCard(label: 'S? di?n tho?i', child: Text(_textOrPlaceholder(_profile['phone']?.toString()), style: const TextStyle(fontWeight: FontWeight.w600))),
          _infoCard(label: 'Email', child: Text(_textOrPlaceholder(_profile['email']?.toString()), style: const TextStyle(fontWeight: FontWeight.w600))),
          _infoCard(label: 'Khoa', child: Text(facultyName, style: const TextStyle(fontWeight: FontWeight.w600))),
          _infoCard(label: 'B? môn', child: Text(departmentName, style: const TextStyle(fontWeight: FontWeight.w600))),
          _infoCard(label: 'Vai trò', child: Text(_roleLabel(roleName), style: const TextStyle(fontWeight: FontWeight.w600))),
          const SizedBox(height: 24),
        ],
      ),
    );
  }

  Widget _infoCard({required String label, required Widget child}) => Card(
        elevation: 1,
        margin: const EdgeInsets.only(bottom: 16),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
            Text(label, style: Theme.of(context).textTheme.bodySmall?.copyWith(color: Colors.grey[600])),
            const SizedBox(height: 6), child,
          ]),
        ),
      );

  String _roleLabel(String v) {
    switch (v.toUpperCase()) {
      case 'ADMIN': return 'Qu?n tr? viên';
      case 'DAO_TAO':
      case 'TRAINING_DEPARTMENT': return 'Phòng dào t?o';
      case 'GIANG_VIEN':
      case 'LECTURER': return 'Gi?ng viên';
      default: return v.isEmpty ? 'Chua xác d?nh' : v;
    }
  }

  Future<void> _openEditSheet() async {
    await _ensureFacultyCache();

    final tmpNameCtrl  = TextEditingController(text: _nameCtrl.text);
    final tmpEmailCtrl = TextEditingController(text: _emailCtrl.text);
    final tmpPhoneCtrl = TextEditingController(text: _phoneCtrl.text);
    DateTime? tmpDob   = _dob;
    String tmpGender   = _genderCode ?? _genderCodeFromProfileValue(_profile['gender']?.toString()) ?? 'Nam';
    int? tmpFacultyId  = _facultyId;
    int? tmpDepartmentId = _departmentId;

    if (tmpFacultyId == null && (_cachedFaculties?.isNotEmpty ?? false)) {
      tmpFacultyId = _asNullableInt(_cachedFaculties!.first['id']);
    }
    if (tmpFacultyId != null) await _loadDepartments(tmpFacultyId);
    if (tmpDepartmentId == null && _departmentsForFaculty(tmpFacultyId).isNotEmpty) {
      tmpDepartmentId = _asNullableInt(_departmentsForFaculty(tmpFacultyId).first['id']);
    }

    final formKey = GlobalKey<FormState>();
    bool submitting = false;
    bool localLoadingDepartments = false;

    Future<void> _loadDepsInSheet(StateSetter refresh, int facultyId) async {
      refresh(() => localLoadingDepartments = true);
      try {
        await _loadDepartments(facultyId);
        final deps = _departmentsForFaculty(facultyId);
        if (!deps.any((d) => _asNullableInt(d['id']) == tmpDepartmentId)) {
          tmpDepartmentId = deps.isNotEmpty ? _asNullableInt(deps.first['id']) : null;
        }
      } finally {
        refresh(() => localLoadingDepartments = false);
      }
    }

    final patch = await showModalBottomSheet<Map<String, dynamic>?>(
      context: context,
      isScrollControlled: true,
      showDragHandle: true,
      builder: (sheetContext) {
        return StatefulBuilder(
          builder: (sheetContext, refresh) {
            return Padding(
              padding: EdgeInsets.only(
                left: 16, right: 16,
                bottom: 16 + MediaQuery.of(sheetContext).viewInsets.bottom,
                top: 8,
              ),
              child: Form(
                key: formKey,
                child: SingleChildScrollView(
                  child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
                    const Text('Ch?nh s?a h? so', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w700)),
                    const SizedBox(height: 12),
                    TextFormField(
                      controller: tmpNameCtrl,
                      decoration: const InputDecoration(labelText: 'H? và tên', prefixIcon: Icon(Icons.person_outline)),
                      validator: (v) => (v == null || v.trim().isEmpty) ? 'H? và tên không du?c d? tr?ng' : null,
                    ),
                    const SizedBox(height: 12),
                    TextFormField(
                      controller: tmpEmailCtrl,
                      keyboardType: TextInputType.emailAddress,
                      decoration: const InputDecoration(labelText: 'Email', prefixIcon: Icon(Icons.email_outlined)),
                      validator: (v) { final s = (v ?? '').trim(); return RegExp(r'^[^@]+@[^@]+\.[^@]+$').hasMatch(s) ? null : 'Email không h?p l?'; },
                    ),
                    const SizedBox(height: 12),
                    TextFormField(
                      controller: tmpPhoneCtrl,
                      keyboardType: TextInputType.phone,
                      decoration: const InputDecoration(labelText: 'S? di?n tho?i', prefixIcon: Icon(Icons.phone_outlined)),
                      validator: (v) { final s = (v ?? '').trim(); if (s.isEmpty) return null; return RegExp(r'^[0-9+() -]{6,30}$').hasMatch(s) ? null : 'S? di?n tho?i không h?p l?'; },
                    ),
                    const SizedBox(height: 12),
                    Row(children: [
                      Expanded(
                        child: InputDecorator(
                          decoration: const InputDecoration(labelText: 'Ngày sinh', prefixIcon: Icon(Icons.cake_outlined)),
                          child: InkWell(
                            onTap: () async {
                              final last = DateTime.now();
                              final picked = await showDatePicker(
                                context: sheetContext,
                                initialDate: tmpDob ?? DateTime(1990, 1, 1),
                                firstDate: DateTime(1950),
                                lastDate: last,
                              );
                              if (picked != null) refresh(() => tmpDob = picked);
                            },
                            child: Padding(
                              padding: const EdgeInsets.symmetric(vertical: 12),
                              child: Text(tmpDob != null ? DateFormat('dd/MM/yyyy').format(tmpDob!) : 'Ch?n ngày'),
                            ),
                          ),
                        ),
                      ),
                    ]),
                    const SizedBox(height: 12),
                    DropdownButtonFormField<String>(
                      value: tmpGender,
                      isExpanded: true,
                      decoration: const InputDecoration(labelText: 'Gi?i tính', prefixIcon: Icon(Icons.wc_outlined)),
                      items: const [
                        DropdownMenuItem(value: 'Nam', child: Text('Nam')),
                        DropdownMenuItem(value: 'N?', child: Text('N?')),
                      ],
                      onChanged: (v) => refresh(() { if (v != null) tmpGender = v; }),
                      validator: (v) => (v == null || v.isEmpty) ? 'Vui lòng ch?n gi?i tính' : null,
                    ),
                    const SizedBox(height: 12),
                    DropdownButtonFormField<int>(
                      value: tmpFacultyId,
                      isExpanded: true,
                      decoration: const InputDecoration(labelText: 'Khoa', prefixIcon: Icon(Icons.school_outlined)),
                      items: [
                        ...?_cachedFaculties?.where((f) => f['id'] != null).map((f) => DropdownMenuItem<int>(
                              value: _asNullableInt(f['id'])!,
                              child: Text(f['name']?.toString() ?? ''),
                            )),
                      ],
                      onChanged: (v) async {
                        if (v == null) return;
                        refresh(() { tmpFacultyId = v; tmpDepartmentId = null; });
                        await _loadDepsInSheet(refresh, v);
                      },
                      validator: (v) => v == null ? 'Vui lòng ch?n khoa' : null,
                    ),
                    const SizedBox(height: 12),
                    DropdownButtonFormField<int>(
                      value: tmpDepartmentId,
                      isExpanded: true,
                      decoration: const InputDecoration(labelText: 'B? môn', prefixIcon: Icon(Icons.account_tree_outlined)),
                      items: _departmentsForFaculty(tmpFacultyId).map((d) => DropdownMenuItem<int>(
                          value: _asNullableInt(d['id'])!, child: Text(d['name']?.toString() ?? ''))).toList(),
                      onChanged: localLoadingDepartments ? null : (v) => refresh(() => tmpDepartmentId = v),
                      validator: (v) => v == null ? 'Vui lòng ch?n b? môn' : null,
                    ),
                    const SizedBox(height: 16),
                    Row(children: [
                      TextButton(onPressed: () => Navigator.of(sheetContext).pop(<String, dynamic>{}), child: const Text('H?y')),
                      const Spacer(),
                      FilledButton(
                        onPressed: submitting ? null : () async {
                          if (!(formKey.currentState?.validate() ?? false)) return;
                          final patch = <String, dynamic>{};
                          void addChange(String key, dynamic newValue, dynamic originalValue) {
                            if (newValue is String && newValue.isEmpty) newValue = null;
                            if (originalValue is String && originalValue.isEmpty) originalValue = null;
                            if (newValue == originalValue) return;
                            patch[key] = newValue;
                          }
                          addChange('name',  tmpNameCtrl.text.trim(), _profile['name']?.toString() ?? '');
                          addChange('email', tmpEmailCtrl.text.trim(), _profile['email']?.toString() ?? '');
                          addChange('phone', tmpPhoneCtrl.text.trim(), _profile['phone']?.toString() ?? '');
                          final origDob = _profile['date_of_birth']?.toString();
                          final newDobStr = tmpDob != null ? DateFormat('yyyy-MM-dd').format(tmpDob!) : null;
                          addChange('date_of_birth', newDobStr, (origDob?.isEmpty == true) ? null : origDob);
                          final origGender = _genderCodeFromProfileValue(_profile['gender']?.toString()) ?? 'Nam';
                          addChange('gender', tmpGender, origGender);
                          addChange('faculty_id', tmpFacultyId, _facultyId);
                          addChange('department_id', tmpDepartmentId, _departmentId);
                          Navigator.of(sheetContext).pop(patch);
                        },
                        child: const Text('Luu'),
                      ),
                    ]),
                  ]),
                ),
              ),
            );
          },
        );
      },
    );

    tmpNameCtrl.dispose();
    tmpEmailCtrl.dispose();
    tmpPhoneCtrl.dispose();

    if (patch != null && patch.isNotEmpty) {
      // Ð?y c?p nh?t sang frame k? ti?p d? tránh ch?m cây widget
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (!mounted) return;
        _updateAfterPatch(patch);
      });
    }
  }

  Future<void> _changePassword() async {
    final oldCtrl = TextEditingController();
    final newCtrl = TextEditingController();
    final confirmCtrl = TextEditingController();
    final formKey = GlobalKey<FormState>();
    bool submitting = false; bool obscureOld = true; bool obscureNew = true; bool obscureConfirm = true; String? errorMessage; bool sheetActive = true;

    final result = await showModalBottomSheet<bool>(
      context: context,
      isScrollControlled: true,
      showDragHandle: true,
      builder: (sheetContext) {
        return StatefulBuilder(builder: (sheetContext, refresh) {
          return Padding(
            padding: EdgeInsets.only(left: 24, right: 24, bottom: 24 + MediaQuery.of(sheetContext).viewInsets.bottom, top: 12),
            child: Column(mainAxisSize: MainAxisSize.min, crossAxisAlignment: CrossAxisAlignment.start, children: [
              const Text('Ð?i m?t kh?u', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600)),
              const SizedBox(height: 16),
              Form(key: formKey, child: Column(children: [
                TextFormField(controller: oldCtrl, obscureText: obscureOld,
                  decoration: InputDecoration(labelText: 'M?t kh?u hi?n t?i', border: const OutlineInputBorder(), suffixIcon: IconButton(icon: Icon(obscureOld?Icons.visibility_off:Icons.visibility), onPressed: (){ refresh((){ obscureOld=!obscureOld;});}),),
                  validator: (v)=> (v==null||v.trim().isEmpty)?'Vui lòng nh?p m?t kh?u hi?n t?i':null,),
                const SizedBox(height: 12),
                TextFormField(controller: newCtrl, obscureText: obscureNew,
                  decoration: InputDecoration(labelText: 'M?t kh?u m?i', border: const OutlineInputBorder(), suffixIcon: IconButton(icon: Icon(obscureNew?Icons.visibility_off:Icons.visibility), onPressed: (){ refresh((){ obscureNew=!obscureNew;});}),),
                  validator: (v){final s=(v??'').trim(); return s.length<8?'M?t kh?u t?i thi?u 8 ký t?':null;},),
                const SizedBox(height: 12),
                TextFormField(controller: confirmCtrl, obscureText: obscureConfirm,
                  decoration: InputDecoration(labelText: 'Xác nh?n m?t kh?u m?i', border: const OutlineInputBorder(), suffixIcon: IconButton(icon: Icon(obscureConfirm?Icons.visibility_off:Icons.visibility), onPressed: (){ refresh((){ obscureConfirm=!obscureConfirm;});}),),
                  validator: (v){final s=(v??'').trim(); if(s.isEmpty) return 'Vui lòng nh?p l?i m?t kh?u m?i'; if(s!=newCtrl.text.trim()) return 'Xác nh?n m?t kh?u không kh?p'; return null;},),
              ])),
              if (errorMessage!=null) ...[const SizedBox(height:12), Text(errorMessage!, style: const TextStyle(color: Colors.red))],
              const SizedBox(height: 16),
              Row(children:[
                TextButton(onPressed: submitting?null:()=>Navigator.of(sheetContext).pop(false), child: const Text('H?y')),
                const Spacer(),
                FilledButton(onPressed: submitting?null:() async {
                  if(!(formKey.currentState?.validate()??false)) return;
                  refresh((){ submitting=true; errorMessage=null;});
                  try{
                    await _service.changePassword(oldPassword: oldCtrl.text.trim(), newPassword: newCtrl.text.trim());
                    if(!sheetActive) return; Navigator.of(sheetContext).pop(true);
                  } on DioException catch(e){
                    if(e.response?.statusCode==401){ Navigator.of(sheetContext).pop(false); await _handleUnauthorized(); return; }
                    final msg = e.response?.data is Map ? (e.response?.data['message']?.toString() ?? e.response?.data['error']?.toString() ?? 'Ð?i m?t kh?u th?t b?i.') : 'Ð?i m?t kh?u th?t b?i.';
                    refresh((){ submitting=false; errorMessage=msg;});
                  } catch(err){ refresh((){ submitting=false; errorMessage=err.toString();}); }
                }, child: const Text('Luu')),
              ])
            ]),
          );
        });
      },
    ).whenComplete(() => sheetActive=false);

    oldCtrl.dispose(); newCtrl.dispose(); confirmCtrl.dispose();
    if (result == true) _showSnackBar('Ð?i m?t kh?u thành công');
  }

  Future<void> _logout() async {
    const storage = FlutterSecureStorage();
    await storage.delete(key: 'access_token');
    await storage.delete(key: 'auth_token');
    if (!mounted) return;
    ref.read(authStateProvider.notifier).logout();
    context.go('/login');
  }
}