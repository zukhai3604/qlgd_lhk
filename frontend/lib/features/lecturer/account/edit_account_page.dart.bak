import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../services/profile_service.dart';
import '../../../common/widgets/app_snackbar.dart';
import '../../../common/utils/validators.dart';
import 'package:dio/dio.dart';

class EditAccountPage extends ConsumerStatefulWidget {
  const EditAccountPage({super.key});

  @override
  ConsumerState<EditAccountPage> createState() => _EditAccountPageState();
}

class _EditAccountPageState extends ConsumerState<EditAccountPage> {
  final _formKey = GlobalKey<FormState>();
  final _nameCtrl = TextEditingController();
  final _emailCtrl = TextEditingController();
  final _phoneCtrl = TextEditingController();
  String? _gender;

  List<Map<String, dynamic>> _faculties = [];
  List<Map<String, dynamic>> _departments = [];
  int? _selectedFacultyId;
  int? _selectedDepartmentId;
  final _departmentNameCtrl = TextEditingController();
  final _facultyNameCtrl = TextEditingController();

  bool _loading = false;

  @override
  void initState() {
    super.initState();
    _loadProfile();
  }

  Future<void> _loadProfile() async {
    try {
      final svc = ref.read(profileServiceProvider);
      final profile = await svc.getProfile();
      _nameCtrl.text = (profile['name'] ?? profile['user']?['name'])?.toString() ?? '';
      _emailCtrl.text = (profile['email'] ?? profile['user']?['email'])?.toString() ?? '';
      _phoneCtrl.text = (profile['phone'] ?? profile['user']?['phone'])?.toString() ?? '';
      // gender
      _gender = (profile['lecturer']?['gender'] ?? profile['gender'])?.toString();

      // try to extract department and faculty ids/names
      final dept = profile['lecturer']?['department'];
      if (dept is Map) {
        final rawId = dept['id'] ?? dept['department_id'];
        _selectedDepartmentId = rawId is int ? rawId : int.tryParse(rawId?.toString() ?? '');
        _departmentNameCtrl.text = (dept['name'] ?? '')?.toString() ?? '';
      } else {
        final rawId = profile['lecturer']?['department_id'];
        _selectedDepartmentId = rawId is int ? rawId : int.tryParse(rawId?.toString() ?? '');
        _departmentNameCtrl.text = (profile['lecturer']?['department_name'] ?? profile['department'] ?? '')?.toString() ?? '';
      }

      // faculty
      final facultyFromDept = (dept is Map) ? dept['faculty'] : null;
      if (facultyFromDept is Map) {
        final rawFid = facultyFromDept['id'] ?? facultyFromDept['faculty_id'];
        _selectedFacultyId = rawFid is int ? rawFid : int.tryParse(rawFid?.toString() ?? '');
        _facultyNameCtrl.text = (facultyFromDept['name'] ?? '')?.toString() ?? '';
      } else {
        final rawFid = profile['lecturer']?['faculty_id'];
        _selectedFacultyId = rawFid is int ? rawFid : int.tryParse(rawFid?.toString() ?? '');
        _facultyNameCtrl.text = (profile['lecturer']?['faculty_name'] ?? profile['faculty'] ?? '')?.toString() ?? '';
      }

      // load faculties list and departments if faculty known
      await _loadFaculties();
      if (_selectedFacultyId != null) {
        await _loadDepartments(_selectedFacultyId);
      }
      setState(() {});
    } catch (e) {
      // ignore: avoid_print
      print('Failed load profile: $e');
    }
  }

  Future<void> _loadFaculties() async {
    try {
      final svc = ref.read(profileServiceProvider);
      final list = await svc.listFaculties();
      _faculties = List<Map<String, dynamic>>.from(list);
    } on DioException catch (_) {
      _faculties = [];
    } catch (_) {
      _faculties = [];
    }
  }

  Future<void> _loadDepartments(int? facultyId) async {
    try {
      final svc = ref.read(profileServiceProvider);
      final list = await svc.listDepartments(facultyId: facultyId);
      _departments = List<Map<String, dynamic>>.from(list);
    } on DioException catch (_) {
      _departments = [];
    } catch (_) {
      _departments = [];
    }
  }

  Future<void> _submit() async {
    if (!_formKey.currentState!.validate()) return;
    setState(() => _loading = true);
    try {
      final svc = ref.read(profileServiceProvider);
      final Map<String, dynamic> payload = {
        'name': _nameCtrl.text.trim(),
        'email': _emailCtrl.text.trim(),
        'phone': _phoneCtrl.text.trim().isEmpty ? null : _phoneCtrl.text.trim(),
        if (_gender != null) 'gender': _gender,
      };

      // faculty / department
      if (_selectedFacultyId != null) {
        payload['faculty_id'] = _selectedFacultyId;
      } else if (_facultyNameCtrl.text.trim().isNotEmpty) {
        payload['faculty'] = _facultyNameCtrl.text.trim();
      }

      if (_selectedDepartmentId != null) {
        payload['department_id'] = _selectedDepartmentId;
      } else if (_departmentNameCtrl.text.trim().isNotEmpty) {
        payload['department'] = _departmentNameCtrl.text.trim();
      }
      final updated = await svc.updateProfile(payload);
      showAppSnackBar(context, 'Cập nhật thông tin thành công.');
      // optionally navigate back
      Navigator.of(context).pop(updated);
    } catch (e) {
      showAppSnackBar(context, 'Cập nhật thất bại: ${e.toString()}', isError: true);
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  @override
  void dispose() {
    _nameCtrl.dispose();
    _emailCtrl.dispose();
    _phoneCtrl.dispose();
    _departmentNameCtrl.dispose();
    _facultyNameCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Chỉnh sửa tài khoản')),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Form(
          key: _formKey,
          child: Column(
            children: [
              TextFormField(
                controller: _nameCtrl,
                decoration: const InputDecoration(labelText: 'Tên'),
                validator: (v) => (v == null || v.trim().isEmpty) ? 'Vui lòng nhập tên.' : null,
              ),
              const SizedBox(height: 12),
              TextFormField(
                controller: _emailCtrl,
                decoration: const InputDecoration(labelText: 'Email'),
                validator: Validators.email,
              ),
              const SizedBox(height: 12),
              DropdownButtonFormField<String>(
                value: _gender,
                items: const [
                  DropdownMenuItem(value: 'Nam', child: Text('Nam')),
                  DropdownMenuItem(value: 'Nữ', child: Text('Nữ')),
                  DropdownMenuItem(value: 'Khác', child: Text('Khác')),
                ],
                onChanged: (v) => setState(() => _gender = v),
                decoration: const InputDecoration(labelText: 'Giới tính'),
              ),
              const SizedBox(height: 12),
              TextFormField(
                controller: _phoneCtrl,
                decoration: const InputDecoration(labelText: 'Số điện thoại (không bắt buộc)'),
                keyboardType: TextInputType.phone,
              ),
              const SizedBox(height: 12),
              // Faculty dropdown
              DropdownButtonFormField<int?>(
                value: _selectedFacultyId,
                decoration: const InputDecoration(labelText: 'Khoa'),
                items: [
                  const DropdownMenuItem<int?>(value: null, child: Text('Chọn hoặc nhập tên...')),
                  ..._faculties.map((f) {
                    final id = f['id'] ?? f['faculty_id'];
                    final name = f['name'] ?? f['faculty_name'] ?? f['title'] ?? '';
                    return DropdownMenuItem<int?>(value: id is int ? id : int.tryParse(id?.toString() ?? ''), child: Text(name.toString()));
                  }).toList(),
                ],
                onChanged: (v) async {
                  setState(() {
                    _selectedFacultyId = v;
                    _selectedDepartmentId = null;
                    _departments = [];
                  });
                  if (v != null) {
                    await _loadDepartments(v);
                    setState(() {});
                  }
                },
              ),
              const SizedBox(height: 12),
              // Department: if we have departments list, show dropdown, otherwise text
              if (_departments.isNotEmpty) ...[
                DropdownButtonFormField<int?>(
                  value: _selectedDepartmentId,
                  decoration: const InputDecoration(labelText: 'Bộ môn'),
                  items: [
                    const DropdownMenuItem<int?>(value: null, child: Text('Chọn bộ môn...')),
                    ..._departments.map((d) {
                      final id = d['id'] ?? d['department_id'];
                      final name = d['name'] ?? d['department_name'] ?? '';
                      return DropdownMenuItem<int?>(value: id is int ? id : int.tryParse(id?.toString() ?? ''), child: Text(name.toString()));
                    }).toList(),
                  ],
                  onChanged: (v) => setState(() => _selectedDepartmentId = v),
                ),
              ] else ...[
                TextFormField(
                  controller: _departmentNameCtrl,
                  decoration: const InputDecoration(labelText: 'Bộ môn (nhập nếu không có trong danh sách)'),
                ),
              ],
              const SizedBox(height: 20),
              SizedBox(
                width: double.infinity,
                child: FilledButton(
                  onPressed: _loading ? null : _submit,
                  child: _loading ? const SizedBox(width:20, height:20, child: CircularProgressIndicator(strokeWidth:2)) : const Text('Lưu'),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
